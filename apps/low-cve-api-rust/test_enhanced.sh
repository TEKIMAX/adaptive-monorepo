#!/bin/bash
set -e

# Kill any existing server instances
pkill -f "low-cve-api-rust" || true
sleep 2

# Build first to ensure changes are picked up
cargo build

# Start server binary directly
./target/debug/low-cve-api-rust &
SERVER_PID=$!
echo "Server PID: $SERVER_PID"

# Wait for startup
echo "Waiting for server..."
for i in {1..30}; do
  if nc -z localhost 8080; then
    echo "Server up."
    break
  fi
  sleep 1
done

# 1. Test Dynamic OpenAPI
echo "Fetching OpenAPI Spec..."
curl -s http://localhost:8080/openapi.json > openapi_dynamic.json

if grep -q "x-ollama-base-url" openapi_dynamic.json; then
  echo "✅ OpenAPI contains x-ollama-base-url documentation."
else
  echo "❌ OpenAPI missing header documentation."
  kill $SERVER_PID
  exit 1
fi

# 2. Test Header Override
# We point to a non-existent port 11111 so connection fails immediately. 
# If logic works, it tries 11111 and fails. If stays on 11434, it might succeed (if ollama running) or fail differently.
echo "Testing Header Override..."
RESPONSE=$(curl -s -X POST http://localhost:8080/v1/responses \
  -H "Content-Type: application/json" \
  -H "x-ollama-base-url: http://localhost:11111" \
  -d '{
    "model": "ollama/test-model",
    "input": [{"type": "message", "role": "user", "content": "hi"}]
  }')

echo "Response: $RESPONSE"

if echo "$RESPONSE" | grep -q "provider_error"; then
  if echo "$RESPONSE" | grep -q "Connection refused"; then
     echo "✅ Received expected connection refused from custom endpoint (11111)."
  else
     echo "⚠️ Received error but unsure if it connected to custom endpoint: $RESPONSE"
  fi
else
   echo "❌ Unexpected success or format."
fi

# Cleanup
kill $SERVER_PID
echo "Done."
