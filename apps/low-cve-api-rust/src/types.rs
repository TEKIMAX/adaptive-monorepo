use serde::{Deserialize, Serialize};
use utoipa::ToSchema;

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
#[serde(tag = "type")]
pub enum InputItem {
    #[serde(rename = "message")]
    Message {
        #[schema(example = "user")]
        role: String,
        content: InputContent,
    },
}

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
#[serde(untagged)]
pub enum InputContent {
    #[schema(example = "Explain quantum computing")]
    String(String),
    Parts(Vec<InputContentPart>),
}

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
#[serde(tag = "type")]
pub enum InputContentPart {
    #[serde(rename = "text")]
    Text { text: String },
    #[serde(rename = "input_text")]
    InputText { text: String },
    #[serde(rename = "inline_data")]
    InlineData { mime_type: String, data: String },
}

#[derive(Debug, Deserialize, ToSchema)]
pub struct CreateResponseRequest {
    #[schema(example = "ollama/gemini-3-flash-preview")]
    pub model: String,
    pub input: Vec<InputItem>,
    pub stream: Option<bool>,
    pub max_output_tokens: Option<u32>,
    pub temperature: Option<f32>,
    pub tools: Option<Vec<Tool>>,
}

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
pub struct Tool {
    #[serde(rename = "google_search")]
    pub google_search: Option<GoogleSearchRetrieval>,
    #[serde(rename = "function_declarations")]
    pub function_declarations: Option<Vec<FunctionDeclaration>>,
}

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
pub struct GoogleSearchRetrieval {}

#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]
pub struct FunctionDeclaration {
    pub name: String,
    pub description: String,
    pub parameters: Option<serde_json::Value>,
}

// --- Output Events ---

#[derive(Debug, Serialize, ToSchema)]
#[serde(tag = "type")]
pub enum OpenResponseEvent {
    #[serde(rename = "response.in_progress")]
    ResponseInProgress { response: ResponseResource },
    #[serde(rename = "response.output_item.added")]
    OutputItemAdded {
        output_index: usize,
        item: OpenResponseItem,
        response_id: String,
    },
    #[serde(rename = "response.output_text.delta")]
    OutputTextDelta {
        item_id: String,
        output_index: usize,
        content_index: usize,
        delta: String,
        response_id: String,
    },
    #[serde(rename = "response.output_item.done")]
    OutputItemDone {
        output_index: usize,
        item: OpenResponseItem,
        response_id: String,
    },
    #[serde(rename = "response.completed")]
    ResponseCompleted { response: ResponseResource },
    #[serde(rename = "response.output_thinking.delta")]
    OutputThinkingDelta {
        delta: String,
        response_id: String,
    },
    #[serde(rename = "error")]
    Error { error: ErrorDetails },
}

#[derive(Serialize, Deserialize, Debug, Clone, ToSchema)]
pub struct Model {
    pub id: String,
    pub object: String, // "model"
    pub created: u64,
    pub owned_by: String,
}

#[derive(Serialize, Deserialize, Debug, Clone, ToSchema)]
pub struct ListModelsResponse {
    pub object: String, // "list"
    pub data: Vec<Model>,
}

#[derive(Debug, Serialize, Clone, ToSchema)]
pub struct ResponseResource {
    pub id: String,
    pub object: String,
    pub created_at: u64,
    pub status: String,
    pub model: String,
    pub output: Vec<OpenResponseItem>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub completed_at: Option<u64>,
    #[serde(skip_serializing_if = "Option::is_none")]
    #[schema(value_type = Option<Object>)]
    pub metadata: Option<std::collections::HashMap<String, String>>,
}

#[derive(Debug, Serialize, Clone, ToSchema)]
#[serde(tag = "type")]
pub enum OpenResponseItem {
    #[serde(rename = "message")]
    Message {
        id: String,
        role: String,
        status: String,
        content: Vec<OutputContentPart>,
    },
    #[serde(rename = "tool_call")]
    ToolCall {
        id: String,
        object: String, // "tool_call"
        status: String, // "in_progress", "done"
        name: String,
        arguments: String, // JSON string
    },
}

#[derive(Debug, Serialize, Clone, ToSchema)]
#[serde(tag = "type")]
pub enum OutputContentPart {
    #[serde(rename = "output_text")]
    OutputText { text: String },
}

#[derive(Debug, Serialize, ToSchema)]
pub struct ErrorDetails {
    pub code: String,
    pub message: String,
}
