use axum::{
    body::Body,
    http::{Request, StatusCode},
    middleware::Next,
    response::Response,
};
use std::env;
use std::time::Instant;

pub async fn auth_middleware(req: Request<Body>, next: Next) -> Result<Response, StatusCode> {
    // Check PROXY_SECRET if set
    if let Ok(proxy_secret) = env::var("PROXY_SECRET") {
        let auth_header = req.headers().get("Authorization")
            .and_then(|h| h.to_str().ok());

        match auth_header {
            Some(header) if header == format!("Bearer {}", proxy_secret) => {
                // valid
            }
            _ => {
                // In a real app we'd return a proper JSON error event, 
                // but for middleware simplicity here we return 401
                return Err(StatusCode::UNAUTHORIZED);
            }
        }
    }
    
    Ok(next.run(req).await)
}

pub async fn cost_middleware(req: Request<Body>, next: Next) -> Response {
    let start = Instant::now();
    let path = req.uri().path().to_owned();
    
    let response = next.run(req).await;
    
    let duration = start.elapsed();
    println!("Request to {} took {:?}", path, duration);
    
    response
}
