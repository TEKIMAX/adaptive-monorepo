#!/bin/bash
set -e

# Cleanup
pkill -f "low-cve-api-rust" || true
sleep 1

# Build
cargo build

# Run
./target/debug/low-cve-api-rust &
SERVER_PID=$!
echo "Server PID: $SERVER_PID"

# Wait
echo "Waiting for server..."
for i in {1..30}; do
  if nc -z localhost 8080; then
    echo "Server up."
    break
  fi
  sleep 1
done

# Test Custom Header Routing
echo "Testing x-custom-base-url routing..."
# Point to port 12345 (likely closed). If it tries to connect and gets "Connection refused", routing worked.
# If it says "Provider not found", routing failed.
RESPONSE=$(curl -s -X POST http://localhost:8080/v1/responses \
  -H "Content-Type: application/json" \
  -H "x-custom-base-url: http://localhost:12345/v1" \
  -d '{
    "model": "any-model-name",
    "input": [{"type": "message", "role": "user", "content": "hi"}]
  }')

echo "Response: $RESPONSE"

if echo "$RESPONSE" | grep -q "Generic Provider Error"; then
   echo "✅ Caught expected Generic Provider Error (likely connection refused)."
elif echo "$RESPONSE" | grep -q "connection refused"; then
   echo "✅ Caught expected connection refused."
elif echo "$RESPONSE" | grep -q "error"; then
   # Generic reqwest connection error
   echo "✅ Routing successful (attempted connection)."
else
   echo "❌ Unexpected response (did it route?)."
fi

# Cleanup
kill $SERVER_PID
echo "Done."
