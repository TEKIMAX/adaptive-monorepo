# Rust Low-CVE-API Architecture

## Overview
This is a high-performance, memory-safe rewrite of the `low-cve-api` Universal Adapter using Rust, Axum, and Tokio. It mimics the original TypeScript architecture but leverages Rust's type safety and concurrency model.

## Directory Structure
```
src/
├── config/         # Configuration logic
│   └── providers.rs # Static provider definitions
├── middleware/     # Axum Middleware
│   ├── auth_middleware # Checks Bearer tokens
│   └── cost_middleware # Tracks request duration
├── providers/      # Provider Implementations (in reqwest)
│   ├── openai.rs
│   ├── nvidia.rs
│   ├── ollama.rs
│   └── gemini.rs
├── traits.rs       # The `Provider` async trait definition
├── types.rs        # Strictly typed OpenResponses Structs/Enums
└── main.rs         # Entrypoint, Router, and SSE event loop
```

## Key Components

### 1. `Provider` Trait (`src/traits.rs`)
Defines the contract for all LLM providers.
```rust
#[async_trait]
pub trait Provider: Send + Sync {
    async fn execute(
        &self,
        req: &CreateResponseRequest,
        sender: Sender<Result<OpenResponseEvent, Box<dyn Error + Send + Sync>>>,
    ) -> Result<(), Box<dyn Error + Send + Sync>>;
}
```
Each provider receives a request and a Tokio `mpsc::Sender` to stream events back to the main thread.

### 2. Event Loop (`src/main.rs`)
The `/v1/responses` handler spawns two tasks:
1.  **Provider Task**: Runs the `execute` method of the selected provider.
2.  **SSE Bridge**: Listens to the `mpsc::Receiver`, serializes `OpenResponseEvent` structs to JSON, and yields them as Server-Sent Events to the client.

### 3. Type Safety (`src/types.rs`)
All inputs and outputs are strictly typed using `serde`. This ensures that invalid JSON is rejected immediately at the API boundary, and guaranteed correct JSON is emitted to the client.

### 4. Chainguard Images
The `Dockerfile` uses `cgr.dev/chainguard/rust` for building and `cgr.dev/chainguard/glibc-dynamic` for runtime, ensuring a minimal attack surface with mostly zero CVEs.
