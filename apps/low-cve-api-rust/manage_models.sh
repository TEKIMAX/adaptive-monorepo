#!/bin/bash
set -e

# Configuration
OLLAMA_HOST="${OLLAMA_HOST:-http://localhost:11434}"
MODEL_NAME="functiongemma"
BASE_MODEL="gemma2:2b"

echo "üîç Checking Ollama Status at $OLLAMA_HOST..."

if ! curl -s "$OLLAMA_HOST/api/version" > /dev/null; then
    echo "‚ùå Ollama is reachable. Please ensure the 'model' service is running."
    exit 1
fi

echo "‚úÖ Ollama is online."

# List models
echo "üìã Checking available models..."
MODELS=$(curl -s "$OLLAMA_HOST/api/tags" | grep -o "\"name\":\"[^\"]*\"" | cut -d'"' -f4)

if echo "$MODELS" | grep -q "^$MODEL_NAME"; then
    echo "‚úÖ Model '$MODEL_NAME' is already installed."
else
    echo "‚ö†Ô∏è  Model '$MODEL_NAME' NOT found."
    echo "‚¨áÔ∏è  Pulling base model '$BASE_MODEL'..."
    
    # Trigger Pull
    curl -X POST "$OLLAMA_HOST/api/pull" -d "{\"name\": \"$BASE_MODEL\", \"stream\": false}"
    
    echo "üîÑ Creating '$MODEL_NAME' from '$BASE_MODEL'..."
    # Create Model (Copy)
    curl -X POST "$OLLAMA_HOST/api/create" -d "{\"name\": \"$MODEL_NAME\", \"modelfile\": \"FROM $BASE_MODEL\"}"
    
    echo "‚úÖ Model '$MODEL_NAME' created successfully!"
fi

echo "üöÄ Ready to serve requests for '$MODEL_NAME'."
