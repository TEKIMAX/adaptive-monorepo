#!/bin/bash
set -e

# Start server in background
cargo run &
SERVER_PID=$!
echo "Server PID: $SERVER_PID"

# Wait for startup (loop until port 8080 is open)
echo "Waiting for server to start..."
for i in {1..30}; do
  if nc -z localhost 8080; then
    echo "Server is up!"
    break
  fi
  echo "Waiting..."
  sleep 2
done

echo "Testing /openapi.json..."
curl -v http://localhost:8080/openapi.json > openapi_response.json
if grep -q "openapi" openapi_response.json; then
  echo "✅ /openapi.json returned valid content."
else
  echo "❌ /openapi.json failed."
  kill $SERVER_PID
  exit 1
fi

echo "Testing /docs..."
curl -v http://localhost:8080/docs > docs_response.html
if grep -q "<!doctype html>" docs_response.html; then
  echo "✅ /docs returned valid HTML."
else
  echo "❌ /docs failed."
  kill $SERVER_PID
  exit 1
fi

# Cleanup
echo "Killing server..."
kill $SERVER_PID
echo "Done."
