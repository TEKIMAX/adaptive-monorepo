# Build Stage
FROM cgr.dev/chainguard/rust:latest AS builder

WORKDIR /app
COPY --chown=nonroot:nonroot . .

# Build release binary
RUN cargo build --release

# Runtime Stage
# using glibc-dynamic to ensure compatibility if we link dynamically
FROM cgr.dev/chainguard/glibc-dynamic

WORKDIR /app
COPY --from=builder /app/target/release/low-cve-api-rust /usr/bin/low-cve-api-rust

# Expose port
EXPOSE 8080

# Environment variables
ENV PORT=8080
ENV RUST_LOG=info
ENV OPENAI_API_KEY=""
ENV GEMINI_API_KEY=""
ENV OLLAMA_API_KEY="c5f758681ad0454d97f9d15c021ba73b.Kvwle4MUNOJf8TOXTXyPXJF0"
ENV OLLAMA_BASE_URL="http://host.docker.internal:11434"

ENTRYPOINT ["/usr/bin/low-cve-api-rust"]
